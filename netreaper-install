#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
#
#    NETREAPER ARSENAL INSTALLER
#    Standalone tool installer for NETREAPER
#
#═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

readonly VERSION="1.0.0"
readonly SCRIPT_NAME="netreaper-install"

# Colors
readonly C_RESET='\033[0m'
readonly C_RED='\033[38;5;196m'
readonly C_GREEN='\033[38;5;46m'
readonly C_YELLOW='\033[38;5;226m'
readonly C_CYAN='\033[38;5;51m'
readonly C_BLUE='\033[38;5;39m'
readonly C_SHADOW='\033[38;5;244m'

# Logging
log_info()    { echo -e "    ${C_CYAN}[*]${C_RESET} $*"; }
log_success() { echo -e "    ${C_GREEN}[✓]${C_RESET} $*"; }
log_warning() { echo -e "    ${C_YELLOW}[!]${C_RESET} $*"; }
log_error()   { echo -e "    ${C_RED}[✗]${C_RESET} $*"; }

# Check root
require_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This installer must be run as root"
        echo -e "    ${C_SHADOW}Usage: sudo $SCRIPT_NAME [category]${C_RESET}"
        exit 1
    fi
}

# Tool categories
# shellcheck disable=SC2034
declare -A TOOLS_SCANNING=(
    [nmap]="apt"
    [masscan]="apt"
    [rustscan]="github:RustScan/RustScan"
    [netdiscover]="apt"
    [arp-scan]="apt"
    [fping]="apt"
    [hping3]="apt"
    [zmap]="apt"
    [nbtscan]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_DNS=(
    [dnsenum]="apt"
    [dnsrecon]="apt"
    [dnsmap]="apt"
    [fierce]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_SSL=(
    [sslscan]="apt"
    [sslyze]="apt"
    [testssl.sh]="git:https://github.com/drwetter/testssl.sh.git"
)

# shellcheck disable=SC2034
declare -A TOOLS_WIFI=(
    [aircrack-ng]="apt"
    [reaver]="apt"
    [bully]="apt"
    [pixiewps]="apt"
    [wifite]="apt"
    [cowpatty]="apt"
    [mdk3]="apt"
    [mdk4]="apt"
    [hostapd]="apt"
    [dnsmasq]="apt"
    [macchanger]="apt"
    [bettercap]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_WEB=(
    [nikto]="apt"
    [sqlmap]="apt"
    [dirb]="apt"
    [gobuster]="apt"
    [wpscan]="gem"
    [ffuf]="go:github.com/ffuf/ffuf/v2@latest"
    [nuclei]="go:github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
    [httpx]="go:github.com/projectdiscovery/httpx/cmd/httpx@latest"
    [subfinder]="go:github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
    [amass]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_EXPLOIT=(
    [metasploit-framework]="apt"
    [exploitdb]="apt"
    [crackmapexec]="pipx"
)

# shellcheck disable=SC2034
declare -A TOOLS_TRAFFIC=(
    [tcpdump]="apt"
    [wireshark]="apt"
    [tshark]="apt"
    [ettercap-text-only]="apt"
    [bettercap]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_OSINT=(
    [theharvester]="apt"
    [recon-ng]="apt"
    [shodan]="pip"
    [maltego]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_CREDS=(
    [hashcat]="apt"
    [john]="apt"
    [hydra]="apt"
    [medusa]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_POST=(
    [impacket-scripts]="apt"
    [python3-impacket]="apt"
)

# shellcheck disable=SC2034
declare -A TOOLS_WORDLISTS=(
    [wordlists]="apt"
    [seclists]="apt"
)

# Install single tool
install_tool() {
    local tool="$1"
    local method="$2"
    
    # Skip if already installed
    if command -v "$tool" &>/dev/null; then
        echo -e "    ${C_GREEN}✓${C_RESET} $tool ${C_SHADOW}(already installed)${C_RESET}"
        return 0
    fi
    
    echo -ne "    ${C_CYAN}○${C_RESET} Installing $tool..."
    
    case "$method" in
        apt)
            if apt install -y "$tool" &>/dev/null; then
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(apt failed)${C_RESET}"
            fi
            ;;
        pip)
            if pip3 install "$tool" &>/dev/null; then
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(pip failed)${C_RESET}"
            fi
            ;;
        pipx)
            if pipx install "$tool" &>/dev/null; then
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(pipx failed)${C_RESET}"
            fi
            ;;
        gem)
            if gem install "$tool" &>/dev/null; then
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(gem failed)${C_RESET}"
            fi
            ;;
        go:*)
            local pkg="${method#go:}"
            if go install "$pkg" &>/dev/null; then
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(go failed)${C_RESET}"
            fi
            ;;
        git:*)
            local repo="${method#git:}"
            local dest="/opt/$tool"
            if git clone --depth 1 "$repo" "$dest" &>/dev/null; then
                [[ -f "$dest/$tool" ]] && ln -sf "$dest/$tool" "/usr/local/bin/$tool"
                [[ -f "$dest/${tool}.sh" ]] && ln -sf "$dest/${tool}.sh" "/usr/local/bin/$tool"
                echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(git failed)${C_RESET}"
            fi
            ;;
        github:*)
            local repo="${method#github:}"
            local latest_url="https://api.github.com/repos/$repo/releases/latest"
            local deb_url
            deb_url=$(curl -s "$latest_url" | grep -o "https://.*amd64.deb" | head -1)
            if [[ -n "$deb_url" ]]; then
                if wget -q "$deb_url" -O "/tmp/${tool}.deb"; then
                    dpkg -i "/tmp/${tool}.deb" &>/dev/null || apt install -f -y &>/dev/null
                    rm -f "/tmp/${tool}.deb"
                    echo -e "\r    ${C_GREEN}✓${C_RESET} $tool"
                else
                    echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(download failed)${C_RESET}"
                fi
            else
                echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(no release found)${C_RESET}"
            fi
            ;;
        *)
            echo -e "\r    ${C_RED}✗${C_RESET} $tool ${C_SHADOW}(unknown method: $method)${C_RESET}"
            ;;
    esac
}

# Install category
install_category() {
    local category="$1"
    # shellcheck disable=SC2178
    local -n tools_ref="TOOLS_${category^^}"
    
    echo
    echo -e "    ${C_BLUE}━━━ Installing ${category^^} tools ━━━${C_RESET}"
    echo
    
    for tool in "${!tools_ref[@]}"; do
        install_tool "$tool" "${tools_ref[$tool]}"
    done
}

# Install all
install_all() {
    log_info "Installing ALL tools (~3-5GB, 15-30 minutes)"
    echo
    
    apt update
    
    install_category "scanning"
    install_category "dns"
    install_category "ssl"
    install_category "wifi"
    install_category "web"
    install_category "exploit"
    install_category "traffic"
    install_category "osint"
    install_category "creds"
    install_category "post"
    install_category "wordlists"
    
    if [[ -f /usr/share/wordlists/rockyou.txt.gz ]]; then
        log_info "Extracting rockyou.txt..."
        gunzip -k /usr/share/wordlists/rockyou.txt.gz 2>/dev/null || true
    fi
    
    echo
    log_success "Installation complete!"
}

# Install essentials only
install_essentials() {
    log_info "Installing essential tools only..."
    echo
    
    apt update
    apt install -y nmap masscan aircrack-ng hashcat john hydra nikto gobuster \
        sqlmap tcpdump wireshark wordlists seclists netdiscover arp-scan
    
    [[ -f /usr/share/wordlists/rockyou.txt.gz ]] && gunzip -k /usr/share/wordlists/rockyou.txt.gz 2>/dev/null
    
    echo
    log_success "Essential tools installed!"
}

# Show status
show_status() {
    echo
    echo -e "    ${C_BLUE}━━━ ARSENAL STATUS ━━━${C_RESET}"
    echo
    
    local installed=0
    local missing=0
    
    for category in SCANNING DNS SSL WIFI WEB EXPLOIT TRAFFIC OSINT CREDS POST; do
        # shellcheck disable=SC2178
        local -n tools_ref="TOOLS_${category}"
        echo -e "    ${C_CYAN}${category}:${C_RESET}"
        echo -n "    "
        for tool in "${!tools_ref[@]}"; do
            if command -v "$tool" &>/dev/null; then
                echo -ne "${C_GREEN}✓${C_RESET}${tool}  "
                ((installed++))
            else
                echo -ne "${C_RED}✗${C_RESET}${tool}  "
                ((missing++))
            fi
        done
        echo
    done
    
    echo
    echo -e "    ${C_GREEN}Installed: $installed${C_RESET}  ${C_RED}Missing: $missing${C_RESET}"
}

# Interactive menu
show_menu() {
    while true; do
        clear
        echo
        echo -e "    ${C_RED}╔═══════════════════════════════════════════════════════════╗${C_RESET}"
        echo -e "    ${C_RED}║${C_RESET}           ${C_CYAN}NETREAPER ARSENAL INSTALLER${C_RESET}                    ${C_RED}║${C_RESET}"
        echo -e "    ${C_RED}╚═══════════════════════════════════════════════════════════╝${C_RESET}"
        echo
        echo -e "    ${C_SHADOW}[1]${C_RESET} Install ALL tools      ${C_SHADOW}(~3-5GB, 15-30 min)${C_RESET}"
        echo -e "    ${C_SHADOW}[2]${C_RESET} Install essentials     ${C_SHADOW}(~500MB, 5 min)${C_RESET}"
        echo
        echo -e "    ${C_SHADOW}[3]${C_RESET} Install SCANNING       ${C_SHADOW}nmap, masscan, rustscan...${C_RESET}"
        echo -e "    ${C_SHADOW}[4]${C_RESET} Install WIRELESS       ${C_SHADOW}aircrack-ng, wifite, bettercap...${C_RESET}"
        echo -e "    ${C_SHADOW}[5]${C_RESET} Install WEB            ${C_SHADOW}nikto, sqlmap, gobuster...${C_RESET}"
        echo -e "    ${C_SHADOW}[6]${C_RESET} Install EXPLOIT        ${C_SHADOW}metasploit, searchsploit...${C_RESET}"
        echo -e "    ${C_SHADOW}[7]${C_RESET} Install CREDENTIALS    ${C_SHADOW}hashcat, john, hydra...${C_RESET}"
        echo -e "    ${C_SHADOW}[8]${C_RESET} Install OSINT          ${C_SHADOW}theharvester, recon-ng...${C_RESET}"
        echo
        echo -e "    ${C_SHADOW}[S]${C_RESET} Show status"
        echo -e "    ${C_SHADOW}[Q]${C_RESET} Quit"
        echo
        echo -ne "    ${C_CYAN}▶${C_RESET} "
        read -r choice
        
        case "$choice" in
            1) install_all ;;
            2) install_essentials ;;
            3) install_category "scanning" ;;
            4) install_category "wifi" ;;
            5) install_category "web" ;;
            6) install_category "exploit" ;;
            7) install_category "creds" ;;
            8) install_category "osint" ;;
            s|S) show_status ;;
            q|Q) exit 0 ;;
            *) log_error "Invalid option" ;;
        esac
        
        echo
        echo -ne "    ${C_SHADOW}Press Enter to continue...${C_RESET}"
        read -r
    done
}

# CLI handling
show_usage() {
    echo "NETREAPER Arsenal Installer v${VERSION}"
    echo
    echo "Usage: sudo $SCRIPT_NAME [command]"
    echo
    echo "Commands:"
    echo "    all          Install all tools"
    echo "    essentials   Install essential tools only"
    echo "    scanning     Install scanning tools"
    echo "    wireless     Install wireless tools"
    echo "    web          Install web tools"
    echo "    exploit      Install exploit tools"
    echo "    creds        Install credential tools"
    echo "    osint        Install OSINT tools"
    echo "    status       Show installation status"
    echo "    menu         Interactive menu (default)"
    echo
}

main() {
    require_root
    
    case "${1:-menu}" in
        all)        apt update; install_all ;;
        essentials) apt update; install_essentials ;;
        scanning)   apt update; install_category "scanning" ;;
        wireless)   apt update; install_category "wifi" ;;
        web)        apt update; install_category "web" ;;
        exploit)    apt update; install_category "exploit" ;;
        creds)      apt update; install_category "creds" ;;
        osint)      apt update; install_category "osint" ;;
        status)     show_status ;;
        menu|"")   show_menu ;;
        -h|--help)  show_usage ;;
        *)          log_error "Unknown command: $1"; show_usage; exit 1 ;;
    esac
}

main "$@"
